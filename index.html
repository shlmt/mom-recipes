<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ספר מתכונים חכם</title>
    
    <!-- Tab Icon (Lucide Chef-Hat as SVG) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23f43f5e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z'/%3E%3Cline x1='6' x2='18' y1='17' y2='17'/%3E%3C/svg%3E">

    <!-- Styles & Fonts -->
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <link rel="stylesheet" href="libs/tailwind.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons Library -->
    <!-- <script src="https://unpkg.com/lucide@latest"></script> -->
    <script src="libs/lucide.js"></script>
    
    <!-- File Parsing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <!-- Register manifest for PWA -->
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('SW registered'))
                .catch(err => console.log('SW registration failed:', err));
        }
    </script>        

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        // pdfjsLib.GlobalWorkerOptions.workerSrc = 'lib/pdf.worker.min.js';
    </script>

    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .lucide { width: 1.25rem; height: 1.25rem; }

        .insert-divider {
            height: 4px;
            margin: -2px 0;
            position: relative;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .insert-divider:hover {
            opacity: 1;
        }
        .insert-btn {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #0f172a;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Custom Notification Toast */
        #toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            min-width: 300px;
            background: white;
            border-right: 4px solid #0f172a;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideLeft 0.3s ease-out;
        }
        @keyframes slideLeft { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Drag & Drop Styles */
        .drag-target-active {
            background-color: #fce7f3 !important; /* rose-100 */
            border-color: #f43f5e !important; /* rose-500 */
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .recipe-card-dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; height: auto; overflow: visible; font-size: 11pt; color: black; }
            #main-area { position: static; overflow: visible; padding: 0 !important; }
            
            h1 { font-size: 22pt !important; margin-bottom: 0.2rem !important; color: black !important; }
            h3 { font-size: 14pt !important; margin-bottom: 0.5rem !important; color: black !important; border-bottom: 1px solid #000 !important; padding-bottom: 2px !important; }
            p { font-size: 10pt !important; line-height: 1.3 !important; color: #333 !important; margin-bottom: 1rem !important; }
            
            .grid { display: grid !important; }
            .gap-10 { gap: 1.5rem !important; }
            
            ::-webkit-scrollbar { display: none; }
            button { display: none !important; }
            
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

            .title-print { margin-top: 0px !important; }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-slate-800">

    <div id="toast-container"></div>

    <!-- Sidebar -->
    <aside class="w-72 bg-white border-l border-slate-100 flex flex-col z-20 shadow-sm shrink-0 no-print">
        <div class="p-8 pb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i data-lucide="chef-hat"></i>
                </div>
                <h1 class="font-black text-2xl tracking-tight text-slate-900">ספר מתכונים חכם</h1>
            </div>
            <p class="text-[10px] font-bold text-slate-400 mr-14 tracking-widest uppercase">מוקדש בתיאבון</p>
        </div>

        <!-- Toolbar Section in Sidebar -->
        <div class="px-6 space-y-4 mb-4 pt-4">
            <button onclick="isOnline ? openImporter() : openEditor()" class="w-full bg-slate-900 text-white py-3.5 rounded-2xl font-black shadow-lg hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2 group">
                <i data-lucide="plus" class="stroke-[3]"></i>
                <span>הוסף מתכון</span>
            </button>

            <!-- Moved Search & Filter -->
            <div class="space-y-3 pt-2">
                <div class="relative group">
                    <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-slate-500 w-4 h-4 transition-colors"></i>
                    <input id="search-input" oninput="renderApp()" class="w-full bg-slate-100/50 focus:bg-white border border-transparent focus:border-slate-200 rounded-xl pr-10 pl-4 py-2.5 text-xs font-bold outline-none transition-all" placeholder="חיפוש מתכון או רכיב...">
                </div>
                
                <div class="flex items-center gap-2 bg-slate-100/50 px-3 py-2.5 rounded-xl border border-transparent focus-within:border-slate-200 group">
                    <i data-lucide="clock" class="text-slate-300 w-4 h-4 group-focus-within:text-slate-500"></i>
                    <select id="time-filter" onchange="renderApp()" class="bg-transparent font-bold text-xs text-slate-600 outline-none cursor-pointer w-full">
                        <option value="">זמן הכנה: הכל</option>
                        <option value="15">עד 15 דק'</option>
                        <option value="30">עד 30 דק'</option>
                        <option value="60">עד שעה</option>
                        <option value="120">עד שעתיים</option>
                    </select>
                </div>
            </div>
        </div>

        <nav id="categories-container" class="flex-1 overflow-y-auto px-4 py-2 space-y-1 custom-scroll">
            <!-- Categories injected via JS -->
        </nav>

        <div class="p-6 pb-2 border-t border-slate-50 space-y-3">
            <div class="flex items-center justify-between px-1">
                <button onclick="exportData()" class="flex items-center gap-2 text-[10px] font-bold text-slate-300 hover:text-blue-500 uppercase tracking-widest transition-colors">
                    <i data-lucide="download" class="w-3 h-3"></i>
                    <span>הורדת גיבוי</span>
                </button>
                
                <button onclick="document.getElementById('importFile').click()" class="flex items-center gap-2 text-[10px] font-bold text-slate-300 hover:text-green-500 uppercase tracking-widest transition-colors">
                    <i data-lucide="upload" class="w-3 h-3"></i>
                    <span>שחזור מקובץ</span>
                </button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(event)">
            </div>

            <button onclick="confirmResetApiKey()" class="flex items-center justify-end gap-2 text-[10px] font-bold text-slate-300 hover:text-red-500 uppercase tracking-widest transition-colors">
                <i data-lucide="key" class="w-3 h-3"></i>
                <span>איפוס מפתח API</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full relative bg-slate-50">
        <!-- Main View Area (Header removed as search moved to sidebar) -->
        <main id="main-area" class="flex-1 overflow-y-auto p-10 custom-scroll relative">
            <!-- Content Injected via JS -->
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4">
        <!-- Modal Content Injected Here -->
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="hidden fixed inset-0 z-[60] bg-white/95 backdrop-blur-xl flex flex-col items-center justify-center">
        <div class="w-16 h-16 border-4 border-slate-100 border-t-rose-500 rounded-full animate-spin mb-6"></div>
        <h3 class="text-2xl font-black text-slate-800 mb-2">השף עובד על זה...</h3>
        <p id="loading-text" class="text-slate-400 font-medium">מנתח את המידע</p>
    </div>

    <script>
        // --- State Management ---
        let recipes = JSON.parse(localStorage.getItem('sparkle_recipes')) || [];
        let view = 'gallery'; 
        let selectedRecipeId = null;
        let categoryFilter = 'הכל';
        let apiKey = localStorage.getItem('gemini_api_key') || "";
        let multiplier = 1;
        let conversionMode = 'original';
        const isOnline = navigator.onLine

        const categories = ['הכל', 'בשרי', 'דגים', 'עוגות', 'עוגות גבינה', 'פינוקים', 'חלבי', 'מאפים', 'סלטים' ];
        
        // מילון שממיר את כל סוגי הכתיב בעברית למפתח אחיד באנגלית לצורך החישוב
        const hebrewToKey = {
            'כוס': 'cup', 'כוסות': 'cup',
            'כף': 'tbsp', 'כפות': 'tbsp',
            'כפית': 'tsp', 'כפיות': 'tsp',
            'גרם': 'metric', 'גר': 'metric', "גר'": 'metric', 'ג\'': 'metric',
            'מל': 'metric', 'מ"ל': 'metric', 'ml': 'metric'
        };

        // מילון להמרה חזרה מאנגלית לעברית (לתצוגה סופית)
        const keyToHebrew = {
            'cup': 'כוס',
            'tbsp': 'כף',
            'tsp': 'כפית'
        };

        // מסד הנתונים (הערכים נשארים באנגלית כמפתחות, אבל נדע לתרגם את התוצאה)
        const conversionDB = {
            // פורמט: { cup: גרם_לכוס, tbsp: גרם_לכף, type: 'weight'/'volume' }
            'קמח קורנפלור קקאו': { cup: 140, tbsp: 10, type: 'weight' }, 
            'קמח מלא': { cup: 125, tbsp: 8, type: 'weight' },
            'סוכר': { cup: 200, tbsp: 10, type: 'weight' },
            'אבקת סוכר': { cup: 120, tbsp: 8, type: 'weight' },
            'סוכר חום': { cup: 240, tbsp: 15, type: 'weight' }, 
            'שמן': { cup: 200, tbsp: 15, type: 'weight' },
            'דבש סילאן': { cup: 360, tbsp: 20, type: 'weight' },
            'אינסטנט פודינג וניל': { tbsp: 10, type: 'weight' },
            "שמרים אבקת אפייה מלח סודה לשתיה ג'לטין": { tsp: 5, type: 'weight' },
            'סולת': { cup: 200, tbsp: 10, type: 'weight' },
            'מים חלב שמנת מתוקה מייפל': { cup: 240, tbsp: 15, type: 'volume' },
            'שמן': { cup: 200, type: 'volume' },
            'ריבת חלב חלבה': { cup: 400, type: 'weight' },
            "שוקולד צ'יפס": { cup: 200, type: 'weight' },
        };

        // ברירת מחדל לרכיבים לא מוכרים (כמו המרת מים)
        const defaultData = { cup: 240, tbsp: 15, tsp: 5, type: 'volume' };

        function getRate(name) {
            if (!name) return defaultData;
            // מחפש התאמה חלקית (למשל "קמח לבן" ימצא את "קמח")
            for (let key in conversionDB) {
                if (name.includes(key)) return conversionDB[key];
            }
            return defaultData;
        }

        // --- Custom UI Elements ---

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast border-r-4 ${type === 'error' ? 'border-red-500' : 'border-slate-900'}`;
            toast.innerHTML = `
                <div class="flex-1 text-sm font-bold text-slate-700">${message}</div>
                <button class="text-slate-300 hover:text-slate-500">✕</button>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
            toast.querySelector('button').onclick = () => toast.remove();
        }

        function showConfirmDialog({ title, message, onConfirm, confirmText = "אישור", cancelText = "ביטול" }) {
            showModal(`
                <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl animate-in zoom-in-95">
                    <h3 class="text-xl font-black text-slate-900 mb-2">${title}</h3>
                    <p class="text-slate-500 font-medium mb-6 leading-relaxed">${message}</p>
                    <div class="flex gap-3">
                        <button onclick="closeModal()" class="flex-1 py-3 bg-slate-50 text-slate-500 rounded-xl font-bold hover:bg-slate-100 transition-colors">${cancelText}</button>
                        <button id="dialog-confirm-btn" class="flex-1 py-3 bg-rose-500 text-white rounded-xl font-black shadow-lg hover:bg-rose-600 transition-all">${confirmText}</button>
                    </div>
                </div>
            `);
            document.getElementById('dialog-confirm-btn').onclick = () => {
                onConfirm();
                closeModal();
            };
        }

        function showPromptDialog({ title, placeholder, onConfirm }) {
            showModal(`
                <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl animate-in zoom-in-95">
                    <h3 class="text-xl font-black text-slate-900 mb-4">${title}</h3>
                    <input id="dialog-prompt-input" class="w-full p-4 bg-slate-50 border-none rounded-xl outline-none focus:ring-2 ring-slate-200 mb-6 font-bold" placeholder="${placeholder}">
                    <div class="flex gap-3">
                        <button onclick="closeModal()" class="flex-1 py-3 bg-slate-50 text-slate-500 rounded-xl font-bold hover:bg-slate-100 transition-colors">ביטול</button>
                        <button id="dialog-prompt-btn" class="flex-1 py-3 bg-slate-900 text-white rounded-xl font-black shadow-lg hover:scale-105 transition-all">אישור</button>
                    </div>
                </div>
            `);
            const input = document.getElementById('dialog-prompt-input');
            input.focus();
            document.getElementById('dialog-prompt-btn').onclick = () => {
                const val = input.value.trim();
                if (val) {
                    onConfirm(val);
                    closeModal();
                } else {
                    showToast("חובה להזין ערך", "error");
                }
            };
        }

        // --- Core Logic ---

        function saveRecipes() {
            localStorage.setItem('sparkle_recipes', JSON.stringify(recipes));
            renderApp();
        }

        function createRecipe(data) {
            const newRecipe = { ...data, id: Date.now().toString(), createdAt: Date.now() };
            recipes.unshift(newRecipe);
            saveRecipes();
            showToast("המתכון נשמר בהצלחה!");
            viewRecipe(newRecipe.id);
        }

        function updateRecipe(id, data, show=true) {
            const idx = recipes.findIndex(r => r.id === id);
            if (idx !== -1) {
                recipes[idx] = { ...recipes[idx], ...data };
                saveRecipes();
                show && showToast("המתכון עודכן");
                if (view === 'detail' && selectedRecipeId === id) renderApp();
            }
        }

        function deleteRecipe(id) {
            showConfirmDialog({
                title: "מחיקת מתכון",
                message: "האם אתה בטוח שברצונך למחוק את המתכון לצמיתות? פעולה זו אינה ניתנת לביטול.",
                onConfirm: () => {
                    recipes = recipes.filter(r => r.id !== id);
                    saveRecipes();
                    showToast("המתכון נמחק");
                    setView('gallery');
                }
            });
        }

        function exportData() {
            const data = localStorage.getItem('sparkle_recipes')
            if (!data || data === '[]') {
                showToast("אין נתונים לשמירה", "error");
                return;
            }

            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const date = new Date().toISOString().slice(0, 10);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_recipes_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("הנתונים נשמרו לקובץ בהצלחה!");
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    if (Array.isArray(json) || (typeof json === 'object')) {
                        confirm = showConfirmDialog({
                            title: "שחזור נתונים",
                            message: "האם לשחזר נתונים מהקובץ? המידע הקיים בדפדפן יימחק!",
                            onConfirm: () => {
                                const data = Array.isArray(json) ? json : json.recipes || [];
                                localStorage.setItem('sparkle_recipes', JSON.stringify(json));
                                showToast("הנתונים שוחזרו בהצלחה!");
                                location.reload();
                            }
                        });
                    } else {
                        showToast("מבנה הקובץ אינו תקין", "error");
                    }
                } catch (err) {
                    showToast("שגיאה בקריאת הקובץ: וודא שזהו קובץ JSON תקין", "error");
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function confirmResetApiKey() {
            showConfirmDialog({
                title: "איפוס API",
                message: "האם למחוק את מפתח ה-API השמור? תצטרך להזין אותו מחדש כדי להשתמש בבינה מלאכותית.",
                onConfirm: () => {
                    localStorage.removeItem('gemini_api_key');
                    apiKey = "";
                    showToast("המפתח נמחק");
                    location.reload();
                }
            });
        }

        function setView(v) {
            view = v;
            if (v === 'gallery') selectedRecipeId = null;
            renderApp();
        }

        function setCategory(cat) {
            categoryFilter = cat;
            setView('gallery');
        }

        // Drag & Drop Logic
        function handleDragStart(ev, id) {
            ev.dataTransfer.setData("text/plain", id);
            ev.target.classList.add("recipe-card-dragging");
        }

        function handleDragEnd(ev) {
            ev.target.classList.remove("recipe-card-dragging");
        }

        function handleDragOver(ev) {
            ev.preventDefault();
            ev.dataTransfer.dropEffect = "move";
            const target = ev.currentTarget;
            if (!target.classList.contains("drag-target-active")) {
                target.classList.add("drag-target-active");
            }
        }

        function handleDragLeave(ev) {
            ev.currentTarget.classList.remove("drag-target-active");
        }

        function handleDrop(ev, category) {
            ev.preventDefault();
            ev.currentTarget.classList.remove("drag-target-active");
            
            const id = ev.dataTransfer.getData("text/plain");
            const recipe = recipes.find(r => r.id === id);
            
            if (recipe) {
                if (category !== 'הכל') {
                    const systemCategories = categories.filter(c => c !== 'הכל');
                    let newTags = (recipe.tags || []).filter(t => !systemCategories.includes(t));
                    newTags.push(category);
                    updateRecipe(id, { ...recipe, tags: newTags }, false);
                    showToast(`המתכון הועבר ל"${category}"`);
                }
            }
        }

        function getMinutes(timeStr) {
            if (!timeStr) return 999;
            const num = parseInt(timeStr.replace(/\D/g, ''));
            if (timeStr.includes('שעה') || timeStr.includes('hour')) return isNaN(num) ? 60 : num * 60;
            return isNaN(num) ? 999 : num;
        }

        const FRACTIONS = {
            '⅒': 1/10,
            '⅑': 1/9,
            '⅛': 1/8,
            '⅐': 1/7,
            '⅙': 1/6,
            '⅕': 1/5,
            '¼': 1/4,
            '⅓': 1/3,
            '⅜': 3/8,
            '⅖': 2/5,
            '½': 1/2,
            '⅗': 3/5,
            '⅝': 5/8,
            '⅔': 2/3,
            '¾': 3/4,
            '⅘': 4/5,
            '⅚': 5/6,
            '⅞': 7/8
        };

        function parseAmount(str) {
            if (!str) return null;
            let s = String(str).trim();

            // מספר רגיל
            if (!isNaN(s)) return parseFloat(s);

            // שבר יוניקוד בלבד (½)
            if (FRACTIONS[s]) return FRACTIONS[s];

            // מספר + שבר (1½, 2⅓)
            for (let f in FRACTIONS) {
                if (s.endsWith(f)) {
                    const whole = parseFloat(s.replace(f, '')) || 0;
                    return whole + FRACTIONS[f];
                }
            }

            // שבר רגיל (1/2)
            if (s.includes('/')) {
                const [a, b] = s.split('/');
                const na = parseFloat(a);
                const nb = parseFloat(b);
                if (!isNaN(na) && !isNaN(nb) && nb !== 0) {
                    return na / nb;
                }
            }

            return null;
        }

        function formatNum(n) {
            if (n === null || n === undefined) return "";

            if (n < 1) {
                for (const [sym, val] of Object.entries(FRACTIONS)) {
                    if (Math.abs(n - val) < 0.02) {
                        return sym;
                    }
                }
            }

            return n.toFixed(1).replace('.0', '');
        }

        // --- AI Logic ---

        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, options);
                    if (res.ok) return await res.json();
                } catch(e) {}
                await new Promise(r => setTimeout(r, 1000));
            }
            throw new Error("שגיאת תקשורת עם השרת");
        }

        async function runGemini(promptText, useSearch = false, imgBase64 = null) {
            if (!apiKey) {
                return new Promise((resolve) => {
                    showPromptDialog({
                        title: "הגדרת API",
                        placeholder: "הכנס מפתח Google Gemini API...",
                        onConfirm: (key) => {
                            apiKey = key;
                            localStorage.setItem('gemini_api_key', apiKey);
                            resolve(runGemini(promptText, useSearch, imgBase64));
                        }
                    });
                });
            }

            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('loading-text').innerText = 'מפענח מתכון...';

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const systemPrompt = `
                You are a professional chef. Extract the recipe from the provided source. Output VALID JSON ONLY in Hebrew.
                If it's a website link, you MUST also extract the original source URL.
                Format: { "title": "", "description": "", "prepTime": "x דק", "difficulty": "קל/בינוני/קשה", "servings": "4 or תבנית 20*30 or 4 אנגליש קייק", "ingredients": [{"item":"", "amount":"", "unit":""}], "instructions": ["step 1"], "tags": [], "imageUrl": "", "sourceUrl": "MANDATORY IF LINK PROVIDED", imageUrl: "MANDATORY IF THERE IS IMAGE IN WEB PAGE" }
            `;

            const parts = [{ text: promptText }];
            if (imgBase64) parts.push({ inlineData: { mimeType: "image/jpeg", data: imgBase64 }});

            const payload = {
                contents: [{ parts }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { 
                    temperature: 0.1 
                }
            };

            if (useSearch) {
                // If using tools, do NOT enforce mime type application/json
                payload.tools = [{ "google_search": {} }];
            } else {
                // Only enforce for non-tool requests
                payload.generationConfig.responseMimeType = "application/json";
            }

            try {
                const data = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                let text = data.candidates[0].content.parts[0].text;
                text = text.replace(/```json/gi, '').replace(/```/g, '').trim();
                
                return JSON.parse(text);
            } catch (e) {
                console.error(e);
                showToast("שגיאת AI: " + e.message, "error");
                return null;
            } finally {
                document.getElementById('loading-screen').classList.add('hidden');
            }
        }

        async function extractFileText(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext === 'txt' || ext === 'md') return await file.text();
            if (ext === 'pdf') {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                let text = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    text += (await page.getTextContent()).items.map(s => s.str).join(" ") + "\n";
                }
                return text;
            }
            if (ext === 'docx') {
                const res = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
                return res.value;
            }
            return "";
        }

        // --- Render UI ---

        function renderApp() {
            renderSidebar();
            const main = document.getElementById('main-area');
            if (view === 'gallery') {
                main.innerHTML = getGalleryHTML();
            } else if (view === 'detail') {
                main.innerHTML = getDetailHTML(selectedRecipeId);
            }
            lucide.createIcons();
        }

        function renderSidebar() {
            const container = document.getElementById('categories-container');
            container.innerHTML = `
                <div class="text-[10px] font-black text-slate-300 px-4 mb-2 uppercase tracking-wider">קטגוריות</div>
                ${categories.map(cat => `
                    <button 
                        onclick="setCategory('${cat}')" 
                        ondragover="handleDragOver(event)"
                        ondragleave="handleDragLeave(event)"
                        ondrop="handleDrop(event, '${cat}')"
                        class="w-full text-right px-4 py-3 rounded-xl text-sm font-bold cursor-pointer transition-all flex items-center justify-between border border-transparent ${categoryFilter === cat ? 'bg-rose-50 text-rose-600' : 'text-slate-500 hover:bg-slate-50'}">
                        ${cat}
                        ${categoryFilter === cat ? '<span class="w-1.5 h-1.5 bg-rose-600 rounded-full"></span>' : ''}
                    </button>
                `).join('')}
            `;
        }

        function getGalleryHTML() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const timeLimit = document.getElementById('time-filter').value;
            
            const filtered = recipes.filter(r => {
                const matchTitle = (r.title||'').toLowerCase().includes(search);
                const matchDesc = (r.description||'').toLowerCase().includes(search);
                const matchTags = (r.tags||[]).some(t => t.toLowerCase().includes(search));
                const matchIngredients = (r.ingredients||[]).some(ing => (ing.item||'').toLowerCase().includes(search));
                
                const matchSearch = matchTitle || matchDesc || matchTags || matchIngredients;
                const matchCat = categoryFilter === 'הכל' || (r.tags||[]).includes(categoryFilter);
                const matchTime = !timeLimit || getMinutes(r.prepTime) <= parseInt(timeLimit);
                return matchSearch && matchCat && matchTime;
            });

            if (filtered.length === 0) return `
                <div class="flex flex-col items-center justify-center h-full opacity-40 mt-20">
                    <i data-lucide="utensils-crossed" class="w-16 h-16 mb-4"></i>
                    <p class="text-xl font-bold">המדף ריק...</p>
                </div>
            `;

            return `
                <div class="max-w-7xl mx-auto animate-in fade-in">
                    <div class="mb-8 flex items-baseline justify-between">
                        <h2 class="text-3xl font-black text-slate-800">${categoryFilter}</h2>
                        <span class="text-slate-400 font-bold">${filtered.length} מתכונים</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 pb-20">
                        ${filtered.map(r => `
                            <div draggable="true" ondragstart="handleDragStart(event, '${r.id}')" ondragend="handleDragEnd(event)" onclick="viewRecipe('${r.id}')" class="group bg-white rounded-[2rem] overflow-hidden cursor-pointer shadow-sm hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 border border-slate-50 flex flex-col h-full">
                                <div class="h-28 relative overflow-hidden bg-slate-100">
                                    ${r.imageUrl ? `<img src="${r.imageUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">` : `<div class="w-full h-full flex items-center justify-center text-slate-300"><i data-lucide="image" class="w-10 h-10"></i></div>`}
                                    <div class="absolute top-4 left-4 bg-white/90 backdrop-blur-md px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider shadow-sm border border-slate-100">${r.difficulty}</div>
                                </div>
                                <div class="p-6 flex-1 flex flex-col">
                                    <h3 class="text-lg font-black text-slate-800 mb-2 leading-tight line-clamp-1 group-hover:text-rose-600 transition-colors">${r.title}</h3>
                                    <p class="text-xs text-slate-500 line-clamp-2 flex-1 font-medium leading-relaxed">${r.description || ''}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function viewRecipe(id) {
            selectedRecipeId = id;
            multiplier = 1;
            conversionMode = 'original';
            setView('detail');
        }

        function getDetailHTML(id) {
            const r = recipes.find(x => x.id === id);
            if (!r) return '';

            const ingredientsHTML = (r.ingredients || []).map(ing => {
                let amt = parseAmount(ing.amount);
                let originalUnit = (ing.unit || '').trim(); // היחידה המקורית בעברית
                
                // שלב 1: נרמול היחידה למפתח אנגלי (למשל: 'כוסות' -> 'cup')
                const unitKey = hebrewToKey[originalUnit] || 
                    Object.keys(hebrewToKey).find(k => originalUnit.includes(k)) 
                    ? hebrewToKey[Object.keys(hebrewToKey).find(k => originalUnit.includes(k))]
                    : null;


                let displayAmt = amt !== null ? amt * multiplier : ing.amount;
                let displayUnit = originalUnit;

                // שליפת נתוני המרה לרכיב הספציפי
                const data = getRate(ing.name || ing.item);

                if (amt !== null && unitKey) {

                    // --- תרחיש א': המשתמש רוצה משקל (גרמים/מ"ל) ---
                    if (conversionMode === 'metric') {
                        // אם היחידה הנוכחית היא כלי בית (כוס/כף) ויש לה ערך המרה
                        if (unitKey !== 'metric' && data[unitKey]) {
                            displayAmt = displayAmt * data[unitKey];
                            
                            // כאן מתבצע התרגום הסופי לעברית:
                            // אם הסוג הוא 'volume' -> נציג מ"ל, אחרת -> גרם
                            displayUnit = (data.type === 'volume') ? 'מ"ל' : 'גרם';
                        }
                    }
                    
                    // --- תרחיש ב': המשתמש רוצה כלי מדידה (כוסות/כפות) ---
                    else if (conversionMode === 'household') {
                        // ממירים רק אם היחידה הנוכחית היא מטרית (גרם/מ"ל)
                        if (unitKey === 'metric') {
                            const currentVal = displayAmt;
                            
                            // סדר בדיקה מהגדול לקטן
                            const checkOrder = ['cup', 'tbsp', 'tsp'];
                            
                            for (let u of checkOrder) {
                                if (data[u]) {
                                    let res = currentVal / data[u];
                                    // אם התוצאה הגיונית (לפחות רבע יחידה)
                                    if (res >= 0.25) {
                                        displayAmt = res;
                                        displayUnit = keyToHebrew[u];
                                        break;
                                    }
                                }
                            }
                            // אם לא נמצאה התאמה, נשאר עם היחידה המקורית
                        }
                    }
                }

                const formattedAmt = amt !== null ? formatNum(displayAmt) : displayAmt;
    
                return `
                    <li class="flex items-baseline justify-between p-2 text-md rounded-xl hover:bg-slate-50 border-b border-dashed border-slate-100 last:border-0 group transition-colors">
                        <span class="font-bold text-slate-700 group-hover:text-slate-900">${ing.item}</span>
                        <span class="font-black text-rose-500 whitespace-nowrap text-lg dir-ltr">
                            ${formattedAmt} <span class="text-[10px] text-slate-400 font-black uppercase">${displayUnit}</span>
                        </span>
                    </li>
                `;
            }).join('');

            return `
                <div class="max-w-4xl mx-auto slide-up pb-10">
                    <button onclick="setView('gallery')" class="mb-4 flex items-center gap-2 text-slate-400 hover:text-slate-800 font-black transition-colors no-print">
                        <i data-lucide="arrow-right" class="w-4 h-4"></i> חזרה
                    </button>

                    <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-slate-100 print:shadow-none print:border-none print:rounded-none">
                        <div class="h-[28vh] relative bg-slate-900 no-print">
                            <!-- Image hidden on print -->
                            <div class="print:hidden h-full w-full absolute inset-0">
                                ${r.imageUrl ? `<img src="${r.imageUrl}" class="w-full h-full object-cover opacity-90">` : `<div class="w-full h-full flex items-center justify-center text-slate-600"><i data-lucide="image" class="w-16 h-16"></i></div>`}
                                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                            </div>
                            
                            <div class="bottom-0 left-0 w-full p-8 text-white">
                                <div class="flex gap-2 mb-4">
                                    ${(r.tags || []).map(t => `
                                        <span class="px-2 py-0.5 bg-white/20 backdrop-blur-md rounded text-[9px] font-black uppercase tracking-widest">
                                            ${t}
                                        </span>
                                    `).join('')}
                                </div>
                                <h1 class="text-4xl mb-1 font-black leading-tight">${r.title}</h1>
                                <h2 class="mb-4 text-slate-200 text-sm">${r.description}</h2>
                                <div class="flex flex-wrap gap-3 text-xs font-bold opacity-90">
                                    ${r.prepTime ? `<span class="flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-full backdrop-blur-sm">
                                        <i data-lucide="clock" class="w-3.5 h-3.5"></i> ${r.prepTime}
                                    </span>` : ''}
                                    ${r.servings ? `<span class="flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-full backdrop-blur-sm">
                                        <i data-lucide="users" class="w-3.5 h-3.5"></i> ${r.servings} ${isNaN(r.servings) ? '' : 'מנות'}
                                    </span>` : ''}
                                    ${r.sourceUrl ? `<a href="${r.sourceUrl}" target="_blank" class="flex items-center gap-2 bg-rose-500 text-white px-4 py-1.5 rounded-full hover:bg-rose-600 shadow-lg transition-all print:hidden"><i data-lucide="external-link" class="w-3.5 h-3.5"></i> מקור</a>` : ''}
                                </div>
                            </div>

                            <div class="absolute top-6 left-6 flex gap-2">
                                <button onclick="window.print()" class="w-10 h-10 bg-white/10 backdrop-blur-md rounded-xl flex items-center justify-center text-white hover:bg-white hover:text-slate-900 transition-all shadow-lg"><i data-lucide="printer" class="w-4 h-4"></i></button>
                                <button onclick="openEditor('${r.id}')" class="w-10 h-10 bg-white/10 backdrop-blur-md rounded-xl flex items-center justify-center text-white hover:bg-white hover:text-slate-900 transition-all shadow-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="deleteRecipe('${r.id}')" class="w-10 h-10 bg-white/10 backdrop-blur-md rounded-xl flex items-center justify-center text-white hover:bg-red-500 transition-all shadow-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>

                        <div class="text-3xl mr-14 font-bold title-print" style="margin-top:-50px">
                            ${r.title}
                        </div>

                        <div class="p-8 print:p-0">
                            <div class="flex flex-wrap gap-3 mb-8 p-3 bg-slate-50 rounded-xl items-center border border-slate-100 no-print">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">כמות:</span>
                                <div class="flex bg-white rounded-lg p-1 shadow-sm border border-slate-100">
                                    ${[0.5, 1, 1.5, 2, 3].map(m => `<button onclick="setMultiplier(${m})" class="px-3 py-1 rounded text-[11px] font-black transition-all ${multiplier === m ? 'bg-slate-900 text-white' : 'text-slate-400 hover:bg-slate-50'}">x${m}</button>`).join('')}
                                </div>
                                <div class="w-px h-5 bg-slate-200 mx-1"></div>
                                <div class="flex gap-2">
                                    <button onclick="toggleConversion('metric')" class="flex items-center gap-1 px-3 py-1.5 rounded-lg text-[11px] font-black transition-all ${conversionMode === 'metric' ? 'bg-rose-100 text-rose-600 shadow-inner' : 'bg-white text-slate-500 shadow-sm border border-slate-100'}">
                                        <i data-lucide="scale" class="w-3.5 h-3.5"></i> למשקל
                                    </button>
                                    <button onclick="toggleConversion('household')" class="flex items-center gap-1 px-3 py-1.5 rounded-lg text-[11px] font-black transition-all ${conversionMode === 'household' ? 'bg-rose-100 text-rose-600 shadow-inner' : 'bg-white text-slate-500 shadow-sm border border-slate-100'}">
                                        <i data-lucide="coffee" class="w-3.5 h-3.5"></i> לכוסות
                                    </button>
                                </div>
                            </div>

                            <div class="grid md:grid-cols-[1fr_1.4fr] gap-10 print:grid-cols-[1fr_2fr] print:gap-8">
                                <div>
                                    <h3 class="text-xl font-black text-slate-900 mb-5 border-b-2 border-slate-100 pb-3 flex items-center gap-2"><i data-lucide="shopping-basket" class="text-rose-500 w-5 h-5 print:text-black"></i> רכיבים</h3>
                                    <ul class="space-y-1">${ingredientsHTML}</ul>
                                    ${r.notes ? `
                                        <div class="mt-8 bg-amber-50 p-4 rounded-xl border border-amber-100 relative print:bg-transparent print:border print:border-dashed print:border-slate-300">
                                            <h4 class="font-black text-amber-900 mb-1 text-[10px] uppercase tracking-wider print:text-black">טיפ מהשף</h4>
                                            <p class="text-amber-800/80 italic text-sm leading-relaxed print:text-black">${r.notes}</p>
                                        </div>
                                    ` : ''}
                                </div>

                                <div>
                                    <h3 class="text-xl font-black text-slate-900 mb-5 border-b-2 border-slate-100 pb-3 flex items-center gap-2"><i data-lucide="list-ordered" class="text-rose-500 w-5 h-5 print:text-black"></i> הכנה</h3>
                                    <div class="space-y-5 print:space-y-3">
                                        ${(r.instructions || []).map((step, i) => `
                                            <div class="flex gap-4 group">
                                                <div class="shrink-0 w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center font-black text-slate-400 text-xs shadow-sm border border-slate-200 print:bg-transparent print:border-black print:text-black">${i + 1}</div>
                                                <p class="text-md text-slate-600 leading-relaxed font-medium pt-0.5 print:text-black">${step}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function setMultiplier(m) { multiplier = m; renderApp(); }

        function toggleConversion(mode) { 
            conversionMode = (conversionMode === mode) ? 'original' : mode; 
            renderApp(); 
        }

        // --- Modals Logic ---

        function openImporter() {
            showModal(`
                <div class="relative w-full max-w-xl bg-white rounded-[2rem] p-10 shadow-2xl">
                    <button onclick="closeModal()" class="absolute top-6 left-6 text-slate-300 hover:text-slate-800 font-bold text-xl transition-colors">✕</button>
                    <h2 class="text-3xl font-black text-center mb-8 text-slate-800">מאיפה המתכון?</h2>
                    
                    <div class="grid grid-cols-3 gap-3 mb-8">
                        <button onclick="setImportTab('link')" id="tab-link" class="import-tab flex flex-col items-center gap-2 p-3 rounded-2xl border-2 transition-all">
                            <i data-lucide="link"></i> <span class="text-[9px] font-black uppercase tracking-widest">קישור</span>
                        </button>
                        <button onclick="setImportTab('file')" id="tab-file" class="import-tab flex flex-col items-center gap-2 p-3 rounded-2xl border-2 transition-all">
                            <i data-lucide="upload-cloud"></i> <span class="text-[9px] font-black uppercase tracking-widest whitespace-nowrap">קובץ או תמונה</span>
                        </button>
                        <button onclick="setImportTab('text')" id="tab-text" class="import-tab flex flex-col items-center gap-2 p-3 rounded-2xl border-2 transition-all">
                            <i data-lucide="type"></i> <span class="text-[9px] font-black uppercase tracking-widest">טקסט</span>
                                                </button>
                    </div>

                    <div id="import-content" class="bg-slate-50 p-6 rounded-3xl mb-8 min-h-[100px] flex flex-col justify-center border border-slate-100">
                        <!-- Content Injected -->
                    </div>

                    <div class="flex gap-4">
                        <button onclick="openEditor()" class="flex-1 py-3.5 bg-slate-100 text-slate-500 rounded-2xl font-bold hover:bg-slate-200 transition-colors">יצירה ידנית</button>
                        <button onclick="runImportAI()" class="flex-[2] py-3.5 bg-slate-900 text-white rounded-2xl font-black shadow-lg hover:shadow-xl hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            <span>צור מתכון חכם</span>
                        </button>
                    </div>
                </div>
            `);
            setImportTab('link');
        }

        let currentImportType = 'link';
        let importFileBase64 = null;
        let importFileData = null;

        function setImportTab(type) {
            currentImportType = type;
            document.querySelectorAll('.import-tab').forEach(el => {
                el.className = 'import-tab flex flex-col items-center gap-2 p-3 rounded-2xl border-2 border-slate-100 text-slate-400 hover:bg-slate-50 transition-all cursor-pointer';
            });
            const active = document.getElementById(`tab-${type}`);
            active.className = 'import-tab flex flex-col items-center gap-2 p-3 rounded-2xl border-2 border-slate-900 bg-white text-slate-900 shadow-md transition-all cursor-pointer';

            const content = document.getElementById('import-content');
            if (type === 'link') {
                content.innerHTML = `<input id="input-link" class="w-full p-4 rounded-xl border-none outline-none shadow-sm font-medium" placeholder="הדבק כאן כתובת אתר..." autofocus>`;
            } else if (type === 'text') {
                content.innerHTML = `<textarea id="input-text" class="w-full h-28 p-4 rounded-xl border-none outline-none shadow-sm font-medium resize-none" placeholder="הדבק כאן את הטקסט של המתכון..."></textarea>`;
            } else if (type === 'file') {
                content.innerHTML = `
                    <div id="file-upload-dropzone" onclick="document.getElementById('file-upload').click()" class="border-2 border-dashed border-slate-300 rounded-2xl h-28 flex flex-col items-center justify-center cursor-pointer hover:border-slate-900 hover:bg-slate-100 transition-all group overflow-hidden relative">
                        <img id="image-preview-import" class="absolute inset-0 w-full h-full object-cover hidden">
                        <div id="file-upload-inner" class="flex flex-col items-center justify-center z-10 bg-white/50 backdrop-blur-sm p-4 rounded-xl">
                            <i data-lucide="plus-circle" class="w-6 h-6 mb-2 text-slate-300 group-hover:text-slate-900"></i>
                        <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-center">העלה תמונה או מסמך</span>
                        </div>
                        <input type="file" id="file-upload" class="hidden" accept="image/*,.pdf,.docx,.txt" onchange="handleFileSelect(this)">
                    </div>
                    <p id="file-name" class="text-center text-xs font-bold mt-2 text-slate-900"></p>
                `;
                const dropzone = document.getElementById('file-upload-dropzone');
                const input = document.getElementById('file-upload');
                if (dropzone && input) {
                    const activate = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropzone.classList.add('drag-target-active');
                    };
                    const deactivate = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropzone.classList.remove('drag-target-active');
                    };
                    ['dragenter', 'dragover'].forEach(evt => dropzone.addEventListener(evt, activate));
                    ['dragleave', 'dragend', 'drop'].forEach(evt => dropzone.addEventListener(evt, deactivate));
                    dropzone.addEventListener('drop', (e) => {
                        const file = e.dataTransfer && e.dataTransfer.files ? e.dataTransfer.files[0] : null;
                        if (file) {
                            handleFileSelect(file);
                        }
                    });
                }
            }
            lucide.createIcons();
        }

        function isSupportedImportFile(file) {
            if (!file) return false;
            const type = file.type || "";
            if (type.startsWith('image/')) return true;
            if (type === 'application/pdf') return true;
            if (type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') return true;
            if (type === 'text/plain') return true;

            const name = (file.name || "").toLowerCase();
            return name.endsWith('.pdf') || name.endsWith('.docx') || name.endsWith('.txt') ||
                name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.jpeg') || name.endsWith('.webp') || name.endsWith('.gif');
        }

        async function handleFileSelect(inputOrFile) {
            const file = (inputOrFile instanceof File)
                ? inputOrFile
                : (inputOrFile && inputOrFile.files ? inputOrFile.files[0] : null);
            if (!file) return;
            if (!isSupportedImportFile(file)) {
                return showToast("סוג הקובץ אינו נתמך", "error");
            }
            importFileData = file;
            document.getElementById('file-name').innerText = file.name;
            
            const isImage = (file.type || "").startsWith('image/');
            const preview = document.getElementById('image-preview-import');
            const inner = document.getElementById('file-upload-inner');

            if (isImage) {
                const reader = new FileReader();
                reader.onload = e => { 
                    importFileBase64 = e.target.result.split(',')[1];
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    inner.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
                inner.classList.remove('hidden');
                importFileBase64 = null;
            }
        }

        async function runImportAI() {
            let promptText = "";
            let base64 = null;
            let useSearch = false;
            let sourceUrl = null;

            if (currentImportType === 'link') {
                sourceUrl = document.getElementById('input-link').value;
                if (!sourceUrl) return showToast("אנא הזן לינק", "error");
                promptText = `Extract professional recipe from URL: ${sourceUrl}. This is the main image on the page and also pull it as an imageUrl`;
                useSearch = true;
            } else if (currentImportType === 'text') {
                const txt = document.getElementById('input-text').value;
                if (!txt) return showToast("אנא הזן טקסט", "error");
                promptText = `Extract recipe from text: ${txt}`;
            } else if (currentImportType === 'file') {
                if (!importFileData) return showToast("אנא בחר קובץ", "error");

                if (importFileData.type.startsWith('image/')) {
                promptText = "Extract full recipe details from this image";
                base64 = importFileBase64;
            } else {
                    const text = await extractFileText(importFileData);
                promptText = `Extract recipe from this document text: ${text}`;
}
            }

            const data = await runGemini(promptText, useSearch, base64);
            if (data) {
                if (base64) data.imageUrl = "data:image/jpeg;base64," + base64;
                if (sourceUrl) data.sourceUrl = sourceUrl;
                openEditor(null, data);
            }
        }

        // --- Editor Logic ---

        function openEditor(id = null, prefillData = null) {
            let data = { title: '', description: '', prepTime: '', servings: '', difficulty: '', ingredients: [], instructions: [], tags: [], imageUrl: '', sourceUrl: '', notes: '' };
            if (id) data = recipes.find(r => r.id === id);
            else if (prefillData) data = { ...data, ...prefillData };

            const buildIngRow = (ing = {}) => `
                <div class="flex gap-2 mb-2 ing-row slide-up relative">
                    <input class="w-16 p-2 bg-slate-50 rounded-lg text-center font-bold text-sm" placeholder="כמות" value="${ing.amount||''}">
                    <input class="w-16 p-2 bg-slate-50 rounded-lg text-center text-sm" placeholder="יח'" value="${ing.unit||''}">
                    <input class="flex-1 p-2 bg-slate-50 rounded-lg text-sm font-medium" placeholder="שם הרכיב" value="${ing.item||''}">
                    <button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `;

            const buildInstRow = (inst = '') => `
                <div class="flex gap-2 mb-2 inst-row slide-up relative">
                    <textarea class="flex-1 p-3 bg-slate-50 rounded-xl text-sm font-medium resize-none h-16 shadow-inner">${inst}</textarea>
                    <button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-red-500 self-center transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `;

            const buildDivider = (type) => `<div class="insert-divider"><div class="insert-btn" onclick="insertItem(this, '${type}')">+</div></div>`;

            const renderIngs = () => {
                let html = "";
                const list = data.ingredients || [];
                list.forEach((ing, i) => {
                    html += buildIngRow(ing);
                    if (i < list.length - 1) html += buildDivider('ing');
                });
                return html || buildIngRow();
            };

            const renderInsts = () => {
                let html = "";
                const list = data.instructions || [];
                list.forEach((inst, i) => {
                    html += buildInstRow(inst);
                    if (i < list.length - 1) html += buildDivider('inst');
                });
                return html || buildInstRow();
            };

            showModal(`
                <div class="bg-white rounded-[2rem] w-full max-w-4xl h-[85vh] flex flex-col overflow-hidden shadow-2xl relative">
                    <div class="p-5 border-b flex justify-between items-center bg-white sticky top-0 z-10">
                        <h2 class="text-xl font-black text-slate-800">עריכת מתכון</h2>
                        <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-8 space-y-8 custom-scroll" id="editor-form">
                        <div class="flex gap-6">
                            <div class="w-1/4">
                                <div class="aspect-square bg-slate-50 rounded-2xl border-2 border-dashed border-slate-200 flex items-center justify-center overflow-hidden relative group">
                                    <img id="preview-img" src="${data.imageUrl || ''}" class="w-full h-full object-cover ${!data.imageUrl ? 'hidden' : ''}">
                                    <div class="absolute inset-0 flex flex-col items-center justify-center ${data.imageUrl ? 'opacity-0 group-hover:opacity-100 bg-black/20 text-white' : ''} transition-all">
                                        <i data-lucide="image-plus"></i>
                                    </div>
                                </div>
                                <input id="edit-img" class="w-full mt-3 p-2 bg-slate-50 rounded-lg text-[10px]" placeholder="URL של תמונה" value="${data.imageUrl||''}" oninput="document.getElementById('preview-img').src=this.value; document.getElementById('preview-img').classList.remove('hidden')">
                            </div>
                            <div class="flex-1 space-y-4">
                                <input id="edit-title" class="text-3xl font-black w-full outline-none border-b-2 border-transparent focus:border-slate-100 placeholder:text-slate-200" value="${data.title}" placeholder="שם המנה...">
                                <textarea id="edit-desc" class="w-full h-16 resize-none outline-none text-slate-500 font-medium text-md leading-relaxed" placeholder="תיאור קצר...">${data.description||''}</textarea>
                                <div class="grid grid-cols-3 gap-3">
                                    <div class="bg-slate-50 p-2.5 rounded-xl">
                                        <label class="text-[9px] font-black text-slate-400 block mb-0.5 uppercase tracking-wider">זמן</label>
                                        <input id="edit-time" class="w-full bg-transparent font-black outline-none text-sm" value="${data.prepTime||''}" placeholder="30 דק'">
                                    </div>
                                    <div class="bg-slate-50 p-2.5 rounded-xl">
                                        <label class="text-[9px] font-black text-slate-400 block mb-0.5 uppercase tracking-wider">מנות</label>
                                        <input id="edit-servings" class="w-full bg-transparent font-black outline-none text-sm" value="${data.servings||''}" placeholder="4">
                                    </div>
                                    <div class="bg-slate-50 p-2.5 rounded-xl">
                                        <label class="text-[9px] font-black text-slate-400 block mb-0.5 uppercase tracking-wider">קושי</label>
                                        <select id="edit-diff" class="w-full bg-transparent font-black outline-none text-sm">
                                            <option ${data.difficulty==='קל'?'selected':''}>קל</option>
                                            <option ${data.difficulty==='בינוני'?'selected':''}>בינוני</option>
                                            <option ${data.difficulty==='קשה'?'selected':''}>קשה</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <div class="bg-slate-50 p-2.5 rounded-xl flex-1">
                                        <label class="text-[9px] font-black text-slate-400 block mb-0.5 uppercase tracking-wider">תגיות</label>
                                        <input id="edit-tags" class="w-full bg-transparent font-bold outline-none text-xs" value="${(data.tags||[]).join(', ')}">
                                    </div>
                                    <div class="bg-slate-50 p-2.5 rounded-xl flex-1">
                                        <label class="text-[9px] font-black text-slate-400 block mb-0.5 uppercase tracking-wider">לינק למקור</label>
                                        <input id="edit-source" class="w-full bg-transparent font-bold outline-none text-xs text-blue-500 dir-ltr text-right" value="${data.sourceUrl||''}" placeholder="https://...">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-10">
                            <section>
                                <h3 class="font-black text-lg mb-3 flex items-center gap-2"><i data-lucide="shopping-basket" class="w-4 h-4"></i> רכיבים</h3>
                                <div id="ing-list" class="space-y-0.5">${renderIngs()}</div>
                                <button onclick="addIngInput()" class="w-full py-2.5 mt-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-black text-[10px] hover:border-slate-900 hover:text-slate-900 transition-all">+ רכיב בסוף</button>
                            </section>
                            <section>
                                <h3 class="font-black text-lg mb-3 flex items-center gap-2"><i data-lucide="list-ordered" class="w-4 h-4"></i> הכנה</h3>
                                <div id="inst-list" class="space-y-0.5">${renderInsts()}</div>
                                <button onclick="addInstInput()" class="w-full py-2.5 mt-3 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-black text-[10px] hover:border-slate-900 hover:text-slate-900 transition-all">+ שלב בסוף</button>
                            </section>
                        </div>
                        
                        <div class="bg-amber-50 p-5 rounded-2xl border border-amber-100">
                             <label class="text-[9px] font-black text-amber-800 block mb-1 uppercase tracking-widest">הערות</label>
                             <textarea id="edit-notes" class="w-full bg-transparent outline-none text-amber-900 h-16 resize-none font-medium text-sm leading-relaxed">${data.notes||''}</textarea>
                        </div>
                    </div>

                    <div class="p-5 border-t bg-white flex justify-end gap-3">
                        <button onclick="closeModal()" class="px-6 py-2.5 text-slate-400 font-bold hover:bg-slate-50 rounded-xl transition-colors">ביטול</button>
                        <button id="save-recipe-btn" class="px-8 py-2.5 bg-slate-900 text-white rounded-xl font-black shadow-lg hover:scale-105 active:scale-95 transition-all">שמור</button>
                    </div>
                </div>
            `);
            document.getElementById('save-recipe-btn').onclick = () => submitRecipe(id);
            lucide.createIcons();
        }

        function insertItem(divider, type) {
            const rowHtml = type === 'ing' ? 
                `<div class="flex gap-2 mb-2 ing-row slide-up relative">
                    <input class="w-16 p-2 bg-slate-50 rounded-lg text-center font-bold text-sm" placeholder="כמות">
                    <input class="w-16 p-2 bg-slate-50 rounded-lg text-center text-sm" placeholder="יח'">
                    <input class="flex-1 p-2 bg-slate-50 rounded-lg text-sm font-medium" placeholder="שם הרכיב">
                    <button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>` : 
                `<div class="flex gap-2 mb-2 inst-row slide-up relative">
                    <textarea class="flex-1 p-3 bg-slate-50 rounded-xl text-sm font-medium resize-none h-16 shadow-inner"></textarea>
                    <button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-red-500 self-center transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>`;
            
            const dividerHtml = `<div class="insert-divider"><div class="insert-btn" onclick="insertItem(this, '${type}')">+</div></div>`;
            const wrapper = document.createElement('div');
            wrapper.innerHTML = rowHtml + dividerHtml;
            divider.parentElement.after(...wrapper.childNodes);
            lucide.createIcons();
        }

        function addIngInput() {
            const list = document.getElementById('ing-list');
            if (list.children.length > 0) {
                const d = document.createElement('div'); d.className = "insert-divider"; d.innerHTML = `<div class="insert-btn" onclick="insertItem(this, 'ing')">+</div>`;
                list.appendChild(d);
            }
            const div = document.createElement('div');
            div.className = "flex gap-2 mb-2 ing-row slide-up relative";
            div.innerHTML = `<input class="w-16 p-2 bg-slate-50 rounded-lg text-center font-bold text-sm" placeholder="כמות"><input class="w-16 p-2 bg-slate-50 rounded-lg text-center text-sm" placeholder="יח'"><input class="flex-1 p-2 bg-slate-50 rounded-lg text-sm font-medium" placeholder="שם הרכיב"><button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>`;
            list.appendChild(div);
            lucide.createIcons();
        }

        function addInstInput() {
            const list = document.getElementById('inst-list');
            if (list.children.length > 0) {
                const d = document.createElement('div'); d.className = "insert-divider"; d.innerHTML = `<div class="insert-btn" onclick="insertItem(this, 'inst')">+</div>`;
                list.appendChild(d);
            }
            const div = document.createElement('div');
            div.className = "flex gap-2 mb-2 inst-row slide-up relative";
            div.innerHTML = `<textarea class="flex-1 p-3 bg-slate-50 rounded-xl text-sm font-medium resize-none h-16 shadow-inner"></textarea><button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-red-500 self-center"><i data-lucide="x" class="w-4 h-4"></i></button>`;
            list.appendChild(div);
            lucide.createIcons();
        }

        function submitRecipe(id) {
            const title = document.getElementById('edit-title').value;
            if(!title) return showToast("חובה להזין שם למתכון", "error");

            const ingredients = Array.from(document.querySelectorAll('.ing-row')).map(row => {
                const inputs = row.querySelectorAll('input');
                return { amount: inputs[0].value, unit: inputs[1].value, item: inputs[2].value };
            }).filter(x => x.item);

            const instructions = Array.from(document.querySelectorAll('.inst-row textarea')).map(x => x.value).filter(x => x);
            const tags = document.getElementById('edit-tags').value.split(',').map(t=>t.trim()).filter(t=>t);

            const data = {
                title,
                description: document.getElementById('edit-desc').value,
                prepTime: document.getElementById('edit-time').value,
                servings: document.getElementById('edit-servings').value,
                difficulty: document.getElementById('edit-diff').value,
                imageUrl: document.getElementById('edit-img').value,
                sourceUrl: document.getElementById('edit-source').value,
                notes: document.getElementById('edit-notes').value,
                ingredients,
                instructions,
                tags: tags.length ? tags : ['כללי']
            };

            if (id) updateRecipe(id, data);
            else createRecipe(data);
            closeModal();
        }

        function showModal(html) {
            const overlay = document.getElementById('modal-overlay');
            overlay.innerHTML = html;
            overlay.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
            importFileData = null;
            importFileBase64 = null;
        }

        // --- Init ---
        window.onload = () => {
            renderApp();
            lucide.createIcons();
        };

    </script>
</body>
</html>
